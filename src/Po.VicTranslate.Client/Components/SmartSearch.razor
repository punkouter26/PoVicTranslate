@using Po.VicTranslate.Client.Services
@inject FuzzyMatchService FuzzyMatch

<div class="smart-search">
    <div class="search-input-wrapper">
        <input 
            type="search"
            class="search-input"
            placeholder="@Placeholder"
            value="@SearchQuery"
            @oninput="OnSearchInput"
            @onkeydown="OnKeyDown"
            @onfocus="() => _isFocused = true"
            @onblur="OnBlur"
            aria-label="Smart search with autocomplete"
            autocomplete="off"
            spellcheck="false"
        />
        @if (!string.IsNullOrWhiteSpace(SearchQuery))
        {
            <button 
                class="clear-search-btn"
                @onclick="ClearSearch"
                aria-label="Clear search"
                type="button">
                ‚úï
            </button>
        }
    </div>

    @if (_showResults && _results.Count > 0)
    {
        <div class="search-results" role="listbox">
            @for (var i = 0; i < _results.Count; i++)
            {
                var index = i; // Capture for closure
                var result = _results[i];
                var isSelected = index == _selectedIndex;
                
                <div 
                    class="search-result-item @(isSelected ? "selected" : "")"
                    role="option"
                    aria-selected="@isSelected"
                    @onclick="() => SelectResult(result)"
                    @onmouseenter="() => _selectedIndex = index">
                    
                    <div class="result-text">
                        @RenderHighlightedText(result)
                    </div>
                    
                    @if (ShowScores)
                    {
                        <div class="result-score">
                            @result.ScorePercent
                        </div>
                    }
                </div>
            }
        </div>
    }

    @if (_showResults && !string.IsNullOrWhiteSpace(SearchQuery) && _results.Count == 0)
    {
        <div class="search-no-results">
            <span class="no-results-icon">üîç</span>
            <span class="no-results-text">No matches found for "@SearchQuery"</span>
        </div>
    }
</div>

@code {
    [Parameter]
    public string Placeholder { get; set; } = "Search...";

    [Parameter]
    public List<string> Items { get; set; } = new();

    [Parameter]
    public EventCallback<string> OnItemSelected { get; set; }

    [Parameter]
    public int MaxResults { get; set; } = 5;

    [Parameter]
    public double Threshold { get; set; } = 0.4;

    [Parameter]
    public bool ShowScores { get; set; } = false;

    [Parameter]
    public int DebounceMs { get; set; } = 300;

    private string SearchQuery { get; set; } = string.Empty;
    private List<FuzzyMatch> _results = new();
    private int _selectedIndex = -1;
    private bool _isFocused = false;
    private bool _showResults = false;
    private System.Threading.Timer? _debounceTimer;

    private void OnSearchInput(ChangeEventArgs e)
    {
        SearchQuery = e.Value?.ToString() ?? string.Empty;
        _selectedIndex = -1;

        // Debounce the search
        _debounceTimer?.Dispose();
        _debounceTimer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(() =>
            {
                PerformSearch();
                StateHasChanged();
            });
        }, null, DebounceMs, Timeout.Infinite);
    }

    private void PerformSearch()
    {
        if (string.IsNullOrWhiteSpace(SearchQuery))
        {
            _results.Clear();
            _showResults = false;
            return;
        }

        _results = FuzzyMatch.FindMatches(SearchQuery, Items, MaxResults, Threshold);
        _showResults = _isFocused;
    }

    private void OnKeyDown(KeyboardEventArgs e)
    {
        if (!_showResults || _results.Count == 0)
        {
            return;
        }

        switch (e.Key)
        {
            case "ArrowDown":
                _selectedIndex = Math.Min(_selectedIndex + 1, _results.Count - 1);
                break;

            case "ArrowUp":
                _selectedIndex = Math.Max(_selectedIndex - 1, -1);
                break;

            case "Enter":
                if (_selectedIndex >= 0 && _selectedIndex < _results.Count)
                {
                    _ = SelectResult(_results[_selectedIndex]);
                }
                break;

            case "Escape":
                _showResults = false;
                _selectedIndex = -1;
                break;

            case "Tab":
                // Allow tab to close results
                _showResults = false;
                _selectedIndex = -1;
                break;
        }
    }

    private async Task SelectResult(FuzzyMatch result)
    {
        SearchQuery = result.Text;
        _showResults = false;
        _selectedIndex = -1;
        await OnItemSelected.InvokeAsync(result.Text);
    }

    private void OnBlur()
    {
        // Delay hiding results to allow click events to fire
        Task.Delay(200).ContinueWith(_ => InvokeAsync(() =>
        {
            _isFocused = false;
            _showResults = false;
            StateHasChanged();
        }));
    }

    private void ClearSearch()
    {
        SearchQuery = string.Empty;
        _results.Clear();
        _showResults = false;
        _selectedIndex = -1;
    }

    private RenderFragment RenderHighlightedText(FuzzyMatch match)
    {
        return builder =>
        {
            var text = match.Text;
            var indices = match.MatchIndices.ToHashSet();
            
            for (var i = 0; i < text.Length; i++)
            {
                if (indices.Contains(i))
                {
                    builder.OpenElement(0, "mark");
                    builder.AddAttribute(1, "class", "match-highlight");
                    builder.AddContent(2, text[i].ToString());
                    builder.CloseElement();
                }
                else
                {
                    builder.AddContent(3, text[i].ToString());
                }
            }
        };
    }

    public void Dispose()
    {
        _debounceTimer?.Dispose();
    }
}
