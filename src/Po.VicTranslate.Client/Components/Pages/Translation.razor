@page "/"
@page "/translate"
@namespace VictorianTranslator.Components.Pages
@using Po.VicTranslate.Client.Services
@using Po.VicTranslate.Client.ViewModels
@using Po.VicTranslate.Client.Extensions
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Forms
@inject ITranslationOrchestrator TranslationOrchestrator
@rendermode InteractiveWebAssembly

<PageTitle>PoVicTranslate</PageTitle>

<div class="main-wrapper animate-fade-in">
    <div class="urban-container">
        @if(_viewModel.IsLoading)
        {
            <div class="loading-overlay">
                <div class="loading-spinner"></div>
                <div class="loading-text">Initializing the culture...</div>
            </div>
        }

        <div class="hero-section">
            <h1 class="urban-title">
                <span class="title-main">Street â†’ Sophisticated</span>
                <small class="title-sub">Transform rap lyrics into Victorian elegance</small>
            </h1>
            <div class="hero-stats">
                <div class="stat-item">
                    <i class="fas fa-music"></i>
                    <span>246 Songs</span>
                </div>
                <div class="stat-divider">â€¢</div>
                <div class="stat-item">
                    <i class="fas fa-magic"></i>
                    <span>AI Powered</span>
                </div>
                <div class="stat-divider">â€¢</div>
                <div class="stat-item">
                    <i class="fas fa-crown"></i>
                    <span>Wu-Tang Edition</span>
                </div>
            </div>
        </div>
        
        <div class="input-section">
            <div class="song-selector-wrapper">
                <label class="urban-label">
                    <i class="fas fa-compact-disc"></i>
                    Choose Your Track
                </label>
                <div class="song-controls">
                    <select id="songSelect" class="form-select urban-select" @onchange="OnSongSelectedAsync">
                        <option value="">-- Drop that beat, select a Wu-Tang classic --</option>
                        @foreach (var song in _viewModel.AvailableSongs)
                        {
                            <option value="@song">@song.Replace(".txt", "").Replace("_", " ").ToTitleCase()</option>
                        }
                    </select>
                    <button class="urban-btn urban-btn-secondary shuffle-btn" @onclick="OnLoadRandomSongAsync" disabled="@(!_viewModel.AvailableSongs.Any())">
                        <i class="fas fa-random"></i>
                        <span>Random</span>
                    </button>
                </div>
            </div>

            <div class="section-divider">
                <span class="divider-text">OR DROP YOUR OWN BARS</span>
                <div class="divider-line"></div>
            </div>

            <div class="custom-input-wrapper">
                <label for="inputText" class="urban-label">
                    <i class="fas fa-microphone"></i>
                    Your Lyrics
                </label>
                <div class="textarea-wrapper">
                    <textarea @bind="_viewModel.InputText" 
                              @bind:event="oninput"
                              class="form-control urban-textarea" 
                              id="inputText" 
                              rows="6"
                              placeholder="Spit your verses here... We'll make 'em sound royal ðŸ‘‘"
                              disabled="@_viewModel.IsTranslating"></textarea>
                    <div class="textarea-overlay">
                        <div class="word-counter @(_viewModel.WordCount > 200 ? "limit-reached" : "")">
                            @_viewModel.WordCount / 200 words
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="action-section">
            <button class="urban-btn primary-action" @onclick="OnTranslateAsync" disabled="@(!_viewModel.CanTranslate)">
                @if (_viewModel.IsTranslating)
                {
                    <div class="btn-content translating">
                        <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
                        <span>Elevating your flow...</span>
                    </div>
                }
                else
                {
                    <div class="btn-content">
                        <i class="fas fa-magic"></i>
                        <span>Transform to Victorian</span>
                    </div>
                }
            </button>
        </div>

        @if (!string.IsNullOrEmpty(_viewModel.TranslatedText))
        {
            <div class="results-section animate-slide-up">
                <label class="urban-label results-label">
                    <i class="fas fa-scroll"></i>
                    Victorian Translation
                </label>
                <div class="result-card">
                    <div class="result-actions">
                        <button class="copy-btn" @onclick="OnCopyToClipboardAsync" title="Copy to clipboard">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    <div class="result-content">
                        @_viewModel.TranslatedText
                    </div>
                </div>
                
                <div class="audio-section">
                    <button class="urban-btn speech-btn" @onclick="OnSpeakTextAsync" disabled="@(!_viewModel.CanSpeak)">
                        @if (_viewModel.IsSpeaking)
                        {
                            <div class="btn-content speaking">
                                <div class="audio-visualizer">
                                    <div class="bar"></div>
                                    <div class="bar"></div>
                                    <div class="bar"></div>
                                </div>
                                <span>Speaking with proper accent...</span>
                            </div>
                        }
                        else
                        {
                            <div class="btn-content">
                                <i class="fas fa-volume-up"></i>
                                <span>Hear It Spoken</span>
                            </div>
                        }
                    </button>
                </div>
            </div>
        }

        @if (!string.IsNullOrEmpty(_viewModel.ErrorMessage))
        {
            <div class="error-section animate-bounce">
                <div class="urban-error">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div class="error-content">
                        <div class="error-title">Oops! Something went sideways</div>
                        <div class="error-message">@_viewModel.ErrorMessage</div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    private readonly TranslationViewModel _viewModel = new();

    protected override async Task OnInitializedAsync()
    {
        await TranslationOrchestrator.InitializeAsync(_viewModel);
    }

    private async Task OnSongSelectedAsync(ChangeEventArgs e)
    {
        var selectedSong = e.Value?.ToString();
        if (string.IsNullOrEmpty(selectedSong))
        {
            _viewModel.InputText = string.Empty;
            return;
        }

        await TranslationOrchestrator.LoadSongAsync(_viewModel, selectedSong);
    }

    private async Task OnLoadRandomSongAsync()
    {
        await TranslationOrchestrator.LoadRandomSongAsync(_viewModel);
    }

    private async Task OnTranslateAsync()
    {
        await TranslationOrchestrator.TranslateTextAsync(_viewModel);
    }

    private async Task OnSpeakTextAsync()
    {
        await TranslationOrchestrator.SpeakTextAsync(_viewModel);
    }

    private async Task OnCopyToClipboardAsync()
    {
        var success = await TranslationOrchestrator.CopyToClipboardAsync(_viewModel.TranslatedText);
        if (!success)
        {
            _viewModel.ErrorMessage = "Failed to copy text to clipboard";
        }
    }
}
