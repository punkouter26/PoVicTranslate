@page "/"
@page "/translate"
@namespace VictorianTranslator.Components.Pages
@using Po.VicTranslate.Client.Services
@using Po.VicTranslate.Client.ViewModels
@using Po.VicTranslate.Client.Components.Pages.Translation
@inject ITranslationOrchestrator TranslationOrchestrator
@inject HistoryService HistoryService
@rendermode InteractiveWebAssembly

<PageTitle>PoVicTranslate</PageTitle>

<!-- Toast Notification -->
<Toast @ref="_toast" Position="ToastPosition.TopRight" />

<div class="main-wrapper animate-fade-in">
    <div class="urban-container">
        @if(_viewModel.IsLoading)
        {
            <div class="loading-overlay">
                <div class="loading-spinner"></div>
                <div class="loading-text">Initializing the culture...</div>
            </div>
        }

        <TranslationHeader />
        
        <div class="input-section">
            <SongSelector 
                AvailableSongs="@_viewModel.AvailableSongs"
                OnSongSelected="@OnSongSelectedAsync"
                OnRandomClick="@OnLoadRandomSongAsync" />

            <div class="section-divider">
                <span class="divider-text">OR DROP YOUR OWN BARS</span>
                <div class="divider-line"></div>
            </div>

            <CustomLyricsInput 
                @bind-CurrentText="@_viewModel.InputText"
                WordCount="@_viewModel.WordCount"
                IsDisabled="@_viewModel.IsTranslating" />
        </div>
        
        <div class="action-section">
            <button class="urban-btn primary-action" @onclick="OnTranslateAsync" disabled="@(!_viewModel.CanTranslate)">
                @if (_viewModel.IsTranslating)
                {
                    <div class="btn-content translating">
                        <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
                        <span>Elevating your flow...</span>
                    </div>
                }
                else
                {
                    <div class="btn-content">
                        <i class="fas fa-magic"></i>
                        <span>Transform to Victorian</span>
                    </div>
                }
            </button>
        </div>

        @if (!string.IsNullOrEmpty(_viewModel.TranslatedText))
        {
            <TranslationResults 
                TranslatedText="@_viewModel.TranslatedText"
                IsEditMode="@_viewModel.IsEditMode"
                IsSpeaking="@_viewModel.IsSpeaking"
                CanSpeak="@_viewModel.CanSpeak"
                OnCopyClick="@OnCopyToClipboardAsync"
                OnEnterEdit="@(() => _viewModel.EnterEditMode())"
                OnSaveEdit="@OnSaveEditAsync"
                OnCancelEdit="@(() => _viewModel.CancelEdit())"
                OnRetranslate="@OnRetranslateAsync"
                OnSpeakClick="@OnSpeakTextAsync" />
        }

        @if (!string.IsNullOrEmpty(_viewModel.ErrorMessage))
        {
            <div class="error-section animate-bounce">
                <div class="urban-error">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div class="error-content">
                        <div class="error-title">Oops! Something went sideways</div>
                        <div class="error-message">@_viewModel.ErrorMessage</div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<!-- Floating Action Button for Mobile -->
<FloatingActionButton 
    OnClick="@OnTranslateAsync"
    IsDisabled="@(!_viewModel.CanTranslate)"
    IsLoading="@_viewModel.IsTranslating"
/>

@code {
    private readonly TranslationViewModel _viewModel = new();
    private Toast? _toast;

    protected override async Task OnInitializedAsync()
    {
        await TranslationOrchestrator.InitializeAsync(_viewModel);
    }

    private async Task OnSongSelectedAsync(string selectedSong)
    {
        if (string.IsNullOrEmpty(selectedSong))
        {
            _viewModel.InputText = string.Empty;
            return;
        }

        await TranslationOrchestrator.LoadSongAsync(_viewModel, selectedSong);
    }

    private async Task OnLoadRandomSongAsync()
    {
        await TranslationOrchestrator.LoadRandomSongAsync(_viewModel);
    }

    private async Task OnTranslateAsync()
    {
        try
        {
            await TranslationOrchestrator.TranslateTextAsync(_viewModel);
            
            if (!string.IsNullOrWhiteSpace(_viewModel.TranslatedText))
            {
                await HistoryService.AddItemAsync(_viewModel.InputText, _viewModel.TranslatedText);
                _toast?.ShowMessage("Translation complete!", ToastType.Success);
            }
        }
        catch (Exception ex)
        {
            _viewModel.ErrorMessage = ex.Message;
            _toast?.ShowMessage($"Translation failed: {ex.Message}", ToastType.Error);
        }
    }

    private async Task OnSpeakTextAsync()
    {
        await TranslationOrchestrator.SpeakTextAsync(_viewModel);
    }

    private async Task OnCopyToClipboardAsync()
    {
        var success = await TranslationOrchestrator.CopyToClipboardAsync(_viewModel.TranslatedText);
        if (success)
        {
            _toast?.ShowMessage("Copied to clipboard!", ToastType.Success);
        }
        else
        {
            _viewModel.ErrorMessage = "Failed to copy text to clipboard";
            _toast?.ShowMessage("Failed to copy to clipboard", ToastType.Error);
        }
    }

    private async Task OnSaveEditAsync(string editedText)
    {
        _viewModel.EditedText = editedText;
        _viewModel.SaveEdit();
        _toast?.ShowMessage("Translation updated!", ToastType.Success);
        await Task.CompletedTask;
    }

    private async Task OnRetranslateAsync()
    {
        _viewModel.ExitEditMode();
        await OnTranslateAsync();
    }
}
