@page "/"
@page "/translate"
@namespace VictorianTranslator.Components.Pages
@using VictorianTranslator.Client.Services
@using VictorianTranslator.Client.Models
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Forms
@inject ClientTranslationService ClientTranslationService
@inject ClientLyricsService ClientLyricsService
@inject IJSRuntime JSRuntime
@rendermode InteractiveWebAssembly

<PageTitle>Urban to Victorian Translator</PageTitle>

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap');

    body {
        background-color: #121212;
    }

    .urban-container {
        background-color: #1a1a1a;
        color: #fff;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
        position: relative;
        overflow: hidden;
    }

    .urban-container::before {
        content: 'W';
        font-family: 'Permanent Marker', cursive;
        position: absolute;
        top: -20px;
        right: -20px;
        font-size: 200px;
        opacity: 0.03;
        transform: rotate(15deg);
    }

    .urban-title {
        font-family: 'Permanent Marker', cursive;
        color: #ffd700;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        font-size: 2.5rem;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .song-controls {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .song-controls .urban-select {
        flex: 1;
    }

    .urban-select {
        background-color: #2d2d2d !important;
        color: #fff !important;
        border: 2px solid #ffd700 !important;
        border-radius: 10px !important;
    }

    .urban-select option {
        background-color: #2d2d2d;
        color: #fff;
    }

    .urban-textarea {
        background-color: #2d2d2d !important;
        color: #fff !important;
        border: 2px solid #ffd700 !important;
        border-radius: 10px !important;
        resize: vertical;
    }

    .word-counter {
        color: #ffd700;
        font-size: 0.9rem;
        text-align: right;
        margin-top: 0.5rem;
    }

    .word-counter.limit-reached {
        color: #ff4444;
    }

    .urban-btn {
        background: linear-gradient(45deg, #ffd700, #ff8c00);
        border: none;
        color: #000;
        font-weight: bold;
        padding: 10px 25px;
        border-radius: 25px;
        text-transform: uppercase;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .urban-btn:hover:not(:disabled) {
        transform: scale(1.05);
        background: linear-gradient(45deg, #ff8c00, #ffd700);
    }

    .urban-btn:disabled {
        opacity: 0.7;
    }

    .urban-btn-secondary {
        background: linear-gradient(45deg, #2d2d2d, #404040);
        border: 2px solid #ffd700;
        color: #ffd700;
    }

    .urban-btn-secondary:hover:not(:disabled) {
        background: linear-gradient(45deg, #404040, #2d2d2d);
    }

    .urban-result {
        background-color: #2d2d2d;
        border: 2px solid #ffd700;
        border-radius: 10px;
        color: #fff;
        position: relative;
    }

    .copy-btn {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background: none;
        border: none;
        color: #ffd700;
        cursor: pointer;
        padding: 0.5rem;
        transition: transform 0.2s;
    }

    .copy-btn:hover {
        transform: scale(1.1);
    }

    .urban-divider {
        color: #ffd700;
        font-family: 'Permanent Marker', cursive;
        font-size: 1.2rem;
        text-align: center;
        margin: 1rem 0;
    }

    .urban-label {
        color: #ffd700;
        font-weight: bold;
        margin-bottom: 0.5rem;
        display: block;
    }

    .urban-error {
        background-color: rgba(255, 68, 68, 0.1);
        border: 2px solid #ff4444;
        color: #ff4444;
        border-radius: 10px;
        padding: 1rem;
        margin-top: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #ffd700;
        border-top: 5px solid transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

<div class="container mt-4">
    <div class="urban-container">
        @if(IsLoading)
        {
            <div class="loading-overlay">
                <div class="loading-spinner"></div>
            </div>
        }

        <h1 class="urban-title">
            Urban Rap â†’ Victorian English
            <small style="font-size: 1rem; opacity: 0.7">(Wu-Tang Edition)</small>
        </h1>
        
        <div class="song-controls">
            <select id="songSelect" class="form-select urban-select" @onchange="LoadLyricsAsync">
                <option value="">-- Select a Wu-Tang Song --</option>
                @foreach (var song in AvailableSongs)
                {
                    <option value="@song">@song.Replace(".txt", "")</option>
                }
            </select>
            <button class="urban-btn urban-btn-secondary" @onclick="LoadRandomSongAsync" disabled="@(!AvailableSongs.Any())">
                <i class="fas fa-random"></i> Random
            </button>
        </div>

        <div class="urban-divider">
            - OR -
        </div>

        <div class="mb-3">
            <label for="inputText" class="urban-label">Drop Your Rap Lyrics:</label>
            <textarea @bind="InputText" 
                      @bind:event="oninput"
                      class="form-control urban-textarea" 
                      id="inputText" 
                      rows="5"
                      placeholder="Type or paste your lyrics here..."
                      disabled="@IsTranslating"></textarea>
            <div class="word-counter @(WordCount > 200 ? "limit-reached" : "")">
                @WordCount / 200 words
            </div>
        </div>
        
        <button class="urban-btn mb-3" @onclick="TranslateTextAsync" disabled="@(IsTranslating || WordCount > 200)">
            @if (IsTranslating)
            {
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                <span class="ms-2">Translating...</span>
            }
            else
            {
                <span>Make It Victorian</span>
            }
        </button>

        @if (!string.IsNullOrEmpty(TranslatedText))
        {
            <div class="mb-3">
                <label class="urban-label">Victorian Translation:</label>
                <div class="p-3 urban-result">
                    <button class="copy-btn" @onclick="CopyToClipboardAsync" title="Copy to clipboard">
                        <i class="fas fa-copy"></i>
                    </button>
                    @TranslatedText
                </div>
                <button class="urban-btn mt-2" @onclick="SpeakTextAsync" disabled="@IsSpeaking">
                    @if (IsSpeaking)
                    {
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        <span class="ms-2">Reading...</span>
                    }
                    else
                    {
                        <i class="fas fa-volume-up"></i>
                        <span>Speak It Proper</span>
                    }
                </button>
            </div>
        }

        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <div class="urban-error">
                <i class="fas fa-exclamation-circle"></i>
                @ErrorMessage
            </div>
        }
    </div>
</div>

@code {
    private string InputText { get; set; } = string.Empty;
    private string TranslatedText { get; set; } = string.Empty;
    private string ErrorMessage { get; set; } = string.Empty;
    private bool IsTranslating { get; set; }
    private bool IsSpeaking { get; set; }
    private bool IsLoading { get; set; }
    private List<string> AvailableSongs { get; set; } = new();

    private int WordCount => string.IsNullOrWhiteSpace(InputText)
        ? 0
        : InputText.Split(new[] { ' ', '\n', '\r' }, StringSplitOptions.RemoveEmptyEntries).Length;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            IsLoading = true;
            AvailableSongs = await ClientLyricsService.GetAvailableSongsAsync();
        }
        catch (Exception)
        {
            ErrorMessage = "Error loading songs.";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task LoadRandomSongAsync()
    {
        if (!AvailableSongs.Any()) return;

        var random = new Random();
        var randomSong = AvailableSongs[random.Next(AvailableSongs.Count)];
        await LoadSongAsync(randomSong);
    }

    private async Task LoadLyricsAsync(ChangeEventArgs e)
    {
        var selectedSong = e.Value?.ToString();
        if (string.IsNullOrEmpty(selectedSong))
        {
            InputText = string.Empty;
            return;
        }

        await LoadSongAsync(selectedSong);
    }

    private async Task LoadSongAsync(string songFileName)
    {
        try
        {
            IsLoading = true;
            ErrorMessage = string.Empty;
            InputText = await ClientLyricsService.GetLyricsAsync(songFileName);
        }
        catch (Exception)
        {
            ErrorMessage = "Error loading lyrics.";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task CopyToClipboardAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", TranslatedText);
        }
        catch (Exception)
        {
            ErrorMessage = "Failed to copy text to clipboard";
        }
    }

    private async Task TranslateTextAsync()
    {
        try
        {
            ErrorMessage = string.Empty;
            if (string.IsNullOrWhiteSpace(InputText))
            {
                ErrorMessage = "Please enter some text to translate.";
                return;
            }

            if (WordCount > 200)
            {
                ErrorMessage = "Please reduce the text to 200 words or less.";
                return;
            }

            IsTranslating = true;
            TranslatedText = await ClientTranslationService.TranslateText(InputText);
        }
        catch (Exception)
        {
            ErrorMessage = "Translation error: An unexpected error occurred.";
            TranslatedText = string.Empty;
        }
        finally
        {
            IsTranslating = false;
        }
    }

    private async Task SpeakTextAsync()
    {
        try
        {
            ErrorMessage = string.Empty;
            if (string.IsNullOrWhiteSpace(TranslatedText))
            {
                ErrorMessage = "No translated text to read.";
                return;
            }

            IsSpeaking = true;
            // This will need to call a server API for text-to-speech
            // For now, it does nothing.
        }
        catch (Exception)
        {
            ErrorMessage = "Text-to-speech error: An unexpected error occurred.";
        }
        finally
        {
            IsSpeaking = false;
        }
    }
}
