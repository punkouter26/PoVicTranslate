name: Build and Deploy to Azure Container Apps

# Blazor Web App with Aspire - Deploy to Azure Container Apps
# Triggers on push to master branch
# Build container image, push to ACR, and update existing Container App

on:
  push:
    branches:
      - master
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  DOTNET_VERSION: '9.0.x'
  AZURE_RESOURCE_GROUP: 'PoVicTranslate'
  SHARED_RESOURCE_GROUP: 'PoShared'
  ACR_NAME: 'acrposhared'
  CONTAINER_APP_NAME: 'ca-povictranslate'
  IMAGE_NAME: 'povictranslate-web'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build solution
      run: dotnet build --configuration Release --no-restore
    
    - name: Run unit tests
      run: dotnet test tests/Po.VicTranslate.UnitTests/Po.VicTranslate.UnitTests.csproj --configuration Release --no-build --verbosity normal
    
    - name: Publish Web App
      run: dotnet publish src/PoVicTranslate.Web/PoVicTranslate.Web.csproj --configuration Release --output ./publish
    
    - name: Azure Login (Federated Credentials)
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    
    - name: Login to Azure Container Registry
      run: az acr login --name ${{ env.ACR_NAME }}
    
    - name: Build and push container image
      run: |
        TAG="${{ github.sha }}"
        az acr build \
          --registry ${{ env.ACR_NAME }} \
          --image ${{ env.IMAGE_NAME }}:$TAG \
          --image ${{ env.IMAGE_NAME }}:latest \
          --file ./src/PoVicTranslate.Web/Dockerfile \
          ./publish
    
    - name: Deploy to Container App
      run: |
        az containerapp update \
          --name ${{ env.CONTAINER_APP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --image ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
    
    - name: Get Container App FQDN
      id: get-fqdn
      run: |
        FQDN=$(az containerapp show \
          --name ${{ env.CONTAINER_APP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --query "properties.configuration.ingress.fqdn" -o tsv)
        echo "FQDN=$FQDN" >> $GITHUB_OUTPUT
        echo "Container App FQDN: $FQDN"
    
    - name: Verify deployment health
      run: |
        echo "Waiting for app to be ready..."
        sleep 60
        FQDN="${{ steps.get-fqdn.outputs.FQDN }}"
        echo "Testing health endpoint at https://$FQDN/health"
        curl -sf "https://$FQDN/health" && echo "Health check passed!" || echo "Health check returned non-success status"
    
    - name: Deployment Summary
      run: |
        echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Resource Group:** ${{ env.AZURE_RESOURCE_GROUP }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Container App:** ${{ env.CONTAINER_APP_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Image:** ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **FQDN:** https://${{ steps.get-fqdn.outputs.FQDN }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Health Endpoint:** https://${{ steps.get-fqdn.outputs.FQDN }}/health" >> $GITHUB_STEP_SUMMARY
    
    - name: Azure logout
      if: always()
      run: az logout
