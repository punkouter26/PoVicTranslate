name: Build and Deploy to Azure Container Apps

# Blazor Web App with Aspire - Deploy to Azure Container Apps
# Triggers on push to master branch
# Uses Aspire CLI and federated credentials for secure deployment

on:
  push:
    branches:
      - master
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  DOTNET_VERSION: '9.0.x'
  AZURE_RESOURCE_GROUP: 'PoVicTranslate'
  AZURE_LOCATION: 'eastus'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Install Aspire workload
      run: dotnet workload install aspire
    
    - name: Install Azure Developer CLI
      uses: Azure/setup-azd@v2
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build solution
      run: dotnet build --configuration Release --no-restore
    
    - name: Run unit tests
      run: dotnet test tests/Po.VicTranslate.UnitTests/Po.VicTranslate.UnitTests.csproj --configuration Release --no-build --verbosity normal
    
    - name: Azure Login (Federated Credentials)
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    
    - name: Login to Azure Developer CLI
      run: azd auth login --client-id ${{ secrets.AZURE_CLIENT_ID }} --federated-credential-provider github --tenant-id ${{ secrets.AZURE_TENANT_ID }}
    
    - name: Deploy with Aspire (azd up)
      run: |
        azd env new production --no-prompt || true
        azd env set AZURE_SUBSCRIPTION_ID ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        azd env set AZURE_LOCATION ${{ env.AZURE_LOCATION }}
        azd env set AZURE_RESOURCE_GROUP ${{ env.AZURE_RESOURCE_GROUP }}
        azd env set existingKeyVaultName kv-poshared
        azd env set existingResourceGroup PoShared
        azd up --no-prompt
      env:
        AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    
    - name: Get Container App FQDN
      id: get-fqdn
      run: |
        FQDN=$(az containerapp show --name ca-povictranslate --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query "properties.configuration.ingress.fqdn" -o tsv 2>/dev/null || echo "")
        if [ -z "$FQDN" ]; then
          FQDN=$(az containerapp list --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query "[0].properties.configuration.ingress.fqdn" -o tsv)
        fi
        echo "FQDN=$FQDN" >> $GITHUB_OUTPUT
        echo "Container App FQDN: $FQDN"
    
    - name: Verify deployment health
      run: |
        echo "Waiting for app to be ready..."
        sleep 45
        FQDN="${{ steps.get-fqdn.outputs.FQDN }}"
        echo "Testing health endpoint at https://$FQDN/health"
        curl -f "https://$FQDN/health" || echo "Health check returned non-success status"
    
    - name: Deployment Summary
      run: |
        echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Resource Group:** ${{ env.AZURE_RESOURCE_GROUP }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Container App FQDN:** https://${{ steps.get-fqdn.outputs.FQDN }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Health Endpoint:** https://${{ steps.get-fqdn.outputs.FQDN }}/health" >> $GITHUB_STEP_SUMMARY
    
    - name: Azure logout
      if: always()
      run: az logout
